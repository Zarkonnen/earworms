<html>
  <head>
    <script type="text/javascript" src="https://www.airconsole.com/api/airconsole-1.3.0.js"></script>
    <script type="text/javascript" src="howler.min.js"></script>
    <script type="text/javascript">
      var airconsole;
      var avatars = [];
      var canvas;
      var last = null;
			var currentWorm = null;
			
			var earworms = [
				"01 - Chumbawamba - Tubthumping",
				"01-dario_g-carneval_de_paris__stadium_radio_edit-pulse",
				"02 Katamari on the Rock ~ Main Theme",
				"04-koji_kondo-overworld_bgm_-_warning_-_overworld_bgm_(hurry_up)-fntx",
				"06. Haddaway - What Is Love ",
				"08 - Enjoy The Silence!!s",
				"18 - Andreas Dorau & Die Marinas - Fred Vom Jupiter",
				"104_rihanna_feat_jay_z_-_umbrella",
				"AHA-TAKE ON ME",
				"anouschka renzi - robot love",
				"Bee Gees - Staying Alive-1",
				"BELINDA-CARLISLE-HEAVEN IS A PLACE ON-EARTH",
				"Bellini - Samba De Janeiro (Club Mix)",
				"COTTON_EYE_JOE_(REDNEX)",
				"d.j. bobo - somebody dance with me",
				"dead or alive - you spin me round",
				"desireless - voyage voyage",
				"Dire Straits - Walk Of Life",
				"eric prydz - generate",
				"eurhythmics - sweet dreams",
				"FoolÂ´s Garden - Lemon tree",
				"Gorillaz - Clint Eastwood (FULL VERSION)",
				"James Last - Medley - Happy Music; Mexican Hat Dance",
				"Kylie Minogue - Cant Get You Out Of My Head (Extended)",
				"Laura Branigan  Self Control",
				"madonna-vogue",
				"Men at work - Down Under",
				"michael jackson - bad [1987] - 10 - smooth criminal",
				"michael jackson - thriller [1984] (r&b) - 04 - thriller",
				"michael jackson - thriller [1984] (r&b) - 06 - billie jean",
				"NENA - 99 LUFTBALLONS",
				"Opus - Live Is Life",
				"ryan paris - dolce vita",
				"sabrina - boys",
				"sandra - everlasting love",
				"yello - oh yeah",
			].map(function(id) {
				return {
					"id": id,
					"howl": new Howl({
						"urls": ["music/" + id + ".ogg", "music/" + id + ".wav"],
						"loop": true
					})
				}
			});
			
			function switchTo(earworm) {
				if (earworm == currentWorm) { return; }
				if (currentWorm) {
					currentWorm.howl.fadeOut(0, 1000);
				}
				earworm.howl.fadeIn(1, 1000);
				currentWorm = earworm;
			}

      /**
       * Sets up the communication to game pads.
       */
      function setupConsole() {
				switchTo(earworms[7]);
        airconsole = new AirConsole();

        airconsole.onConnect = function(device_id) {
					avatars.push({
						"x": 20,
						"y": 20,
						"move": { "x": 0, "y": 0},
						"songId": 0
					});
          checkAtLeastTwoPlayers();
        };

        airconsole.onDisconnect = function(device_id) {
					var player = airconsole.convertDeviceIdToPlayerNumber(device_id);
					avatars.splice(player, 1);
          checkAtLeastTwoPlayers();
        };

        airconsole.onMessage = function(device_id, data) {
          var player = airconsole.convertDeviceIdToPlayerNumber(device_id);
          if (player != undefined && data["joystick-left"] !== undefined && data["joystick-left"].message !== undefined) {
            avatars[player].move.x = data["joystick-left"].message.x || 0;
			avatars[player].move.y = data["joystick-left"].message.y || 0;
          }
        };
      }

      function checkAtLeastTwoPlayers() {
        var active_players = airconsole.getActivePlayerDeviceIds();
        var connected_controllers = airconsole.getControllerDeviceIds();
        if (connected_controllers.length >= 2) {
          airconsole.setActivePlayers(connected_controllers.length);
          document.getElementById("wait").innerHTML = "";
        } else {
					airconsole.setActivePlayers(0);
          document.getElementById("wait").innerHTML = "Need " + (2 - connected_controllers.length) + " more player(s)!";
        }
      }

      /**
       * body.onload function.
       */
      function init() {
        setupConsole();

        // Setting up the game. Nothing AirConsole specific.

        canvas = document.getElementById("canvas");
        avatars = [];
        canvas.width = canvas.clientWidth;
        canvas.height = canvas.clientHeight;
        window.onresize = (clearCanvas);
        last = new Date().getTime();
        loop();
      }

      /**
       * Moving the ball and drawing the canvas. Nothing AirConsole specific.
       */
      function loop() {
        var now = new Date().getTime();
        var delta = (now - last);
        delta = Math.min(20, delta);
        delta /= 1000;
        last = now;
        draw(true);
		
		avatars.forEach(function(p) {
			moveAvatar(p, delta);
		});
        draw();

		checkSoundCones();
        requestAnimationFrame(loop);
      }

	  function moveAvatar(p, delta) {
		p.x += p.move.x*20*delta;
		p.y += p.move.y*20*delta;
		p.x = Math.max(0, Math.min(100, p.x));
		p.y = Math.max(0, Math.min(100, p.y));
	  }
	  
	  function getConeCorners(a, avatarRadius) {
		var corners = [];
		var coneWidth = 20;
		var coneLength = 30;
		corners.push({"x": a.x, "y": a.y - avatarRadius});
		corners.push({"x": a.x + coneWidth / 2, "y": a.y + coneLength});
		corners.push({"x": a.x - coneWidth / 2, "y": a.y + coneLength});
		return corners;
	  }
	  
	  function checkSoundCones() {
		for (i=0;i<avatars.length;i++)
		{
			for (j=0;j<avatars.length;j++)
			{
				if (i != j)
				{
					corners = getConeCorners(avatars[i], 5);
					if (PointInTriangle({"x": avatars[j].x, "y": avatars[j].y}, corners[0], corners[1], corners[2]))
					{
						console.log("Avatar " + j + " inside cone " + i);
					}					
				}
			}
		}

		function sign (p1, p2, p3) {
			return (p1.x - p3.x) * (p2.y - p3.y) - (p2.x - p3.x) * (p1.y - p3.y);
		}

		function PointInTriangle (point, corner1, corner2, corner3) {
			var b1, b2, b3;

			b1 = sign(point, corner1, corner2) < 0;
			b2 = sign(point, corner2, corner3) < 0;
			b3 = sign(point, corner3, corner1) < 0;

			return ((b1 == b2) && (b2 == b3));
		}
	}
	  
      function clearCanvas() {
        var ctx = canvas.getContext("2d");
        ctx.fillStyle = "black";
        canvas.width = canvas.clientWidth;
        canvas.height = canvas.clientHeight;
        ctx.fillRect(0,0, canvas.width, canvas.height);
      }
	  
      /**
       * Drawing the game scene. Nothing Game Console specific.
       * @param clear
       */
      function draw(clear) {
				if (clear) { clearCanvas(); }
        // Draw
        var ctx = canvas.getContext("2d");
        var zoom = canvas.clientHeight / 100;
		var avatarRadius = 5;
		
		function c(x) {
		  x *= zoom;
		  return x | 0; // round
		}

		// scale to screen
        ctx.fillStyle = 'white';
		
		// draw all sound cones
		avatars.forEach(function(a) {
			var corners = getConeCorners(a, avatarRadius);
			drawTriangle(ctx, corners, 'green');
		});
		
		// draw all avatars
		avatars.forEach(function(a) {
			drawCircle(ctx, a.x, a.y, avatarRadius);
		});

		function drawCircle(context, x, y, radius)
		{
			context.beginPath();
			context.arc(c(x), c(y), c(radius), 0, 2 * Math.PI, false);
			context.fill();
			context.closePath();
		}
		
		function drawTriangle(context, corners, fillStyle)
		{
			if (corners.length > 2)
			{
				context.beginPath();
				context.moveTo(c(corners[0].x), c(corners[0].y));
				context.lineTo(c(corners[1].x), c(corners[1].y));
				context.lineTo(c(corners[2].x), c(corners[2].y));
				context.closePath();
				
				var oldStyle = context.fillStyle;
				context.fillStyle = fillStyle;
				context.fill();
				context.fillStyle = oldStyle;
			}
		}
      }
	  
    </script>
    <style type="text/css">
      @font-face {
        font-family: 'PressStart2P';
        src: url('PressStart2P.ttf') format('truetype');
      }

      html, body {
        height: 100%;
        margin: 0px;
        font-family: 'PressStart2P', sans-serif;
        color: white;
        text-align: center;
      }

      .game {
        background-color: black;
        top: 50%;
        margin-top: -25%;
        padding-bottom: 50%;
        overflow: hidden;
        position: relative;
      }

      #canvas {
        position: absolute;
        top: 0px;
        left:0px;
        width: 100%;
        height: 100%;
      }

      #score {
        position: absolute;
        top: 10%;
        left: 0px;
        width: 100%;
        font-size: 48px;
      }

      #wait {
        position: absolute;
        top: 10%;
        margin-top: 80px;
        left: 0px;
        width: 100%;
        font-size: 24px;
        color: lime;
      }
    </style>
  </head>
  <body onload="init()">
    <div class="game">
      <canvas id="canvas"></canvas>
      <div id="wait"></div>
    </div>
  </body>
</html>
